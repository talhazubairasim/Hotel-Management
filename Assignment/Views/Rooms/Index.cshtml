@model IEnumerable<Assignment.Models.Room>

<h2>Rooms</h2>
<p><a asp-action="Create" class="btn btn-success"><i class="fa fa-plus"></i> Add Room</a></p>

<div class="card">
    <div class="card-header bg-dark text-white">
        <h5 class="mb-0"><i class="fa fa-bed"></i> Rooms List</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0" id="roomsTable">
                <thead class="table-dark">
                    <tr>
                        <th class="sortable" data-column="name" data-sort="none">
                            <i class="fa fa-door-open"></i> Name
                            <i class="fa fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="floor" data-sort="none">
                            <i class="fa fa-building-o"></i> Floor
                            <i class="fa fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="hotel" data-sort="none">
                            <i class="fa fa-hotel"></i> Hotel
                            <i class="fa fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="type" data-sort="none">
                            <i class="fa fa-star"></i> Type
                            <i class="fa fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="charges" data-sort="none">
                            <i class="fa fa-usd"></i> Charges (per day)
                            <i class="fa fa-sort sort-icon"></i>
                        </th>
                        <th><i class="fa fa-cogs"></i> Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in Model)
                    {
                        <tr id="room-@r.RoomId">
                            <td class="fw-semibold">@r.Name</td>
                            <td>
                                <span class="badge bg-info">Floor @r.Floor</span>
                            </td>
                            <td class="fw-semibold text-primary">@r.Hotel?.Name</td>
                            <td>
                                <span class="badge @(r.Type == "Luxury" ? "bg-warning text-dark" :
                                                                                      r.Type == "Deluxe" ? "bg-success" : "bg-secondary")">
                                    @r.Type
                                </span>
                            </td>
                            <td class="fw-bold text-success">
                                $@r.Charges.ToString("N0")
                            </td>
                            <td>
                                <a asp-action="Edit" asp-route-id="@r.RoomId" class="btn btn-sm btn-primary">
                                    <i class="fa fa-edit"></i> Edit
                                </a>
                                <button type="button"
                                        class="btn btn-sm btn-danger delete-btn ms-1"
                                        data-room-id="@r.RoomId"
                                        data-room-name="@r.Name">
                                    <i class="fa fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            @Html.AntiForgeryToken()
        </div>
    </div>
    <div class="card-footer text-muted">
        <i class="fa fa-info-circle"></i>
        Click column headers to sort. Click again to reverse order.
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('.sortable').each(function() {
                $(this).data('sort', 'none');
            });

            $('.sortable').click(function() {
                var column = $(this).data('column');
                var currentSort = $(this).data('sort');

                var newSort = currentSort === 'asc' ? 'desc' : 'asc';

                $(this).data('sort', newSort);

                $('.sortable').not(this).data('sort', 'none');

                $('.sort-icon').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');
                var sortIcon = $(this).find('.sort-icon');
                sortIcon.removeClass('fa-sort')
                       .addClass(newSort === 'asc' ? 'fa-sort-up' : 'fa-sort-down');

                sortTable(column, newSort);

                toastr.success(`Sorted by ${getColumnDisplayName(column)} (${newSort === 'asc' ? 'asc' : 'desc'})`);
            });

            $('.sortable').hover(
                function() {
                    $(this).addClass('bg-primary text-white').css('cursor', 'pointer');
                },
                function() {
                    $(this).removeClass('bg-primary text-white');
                }
            );
        });

        function sortTable(column, direction) {
            var table = $('#roomsTable');
            var tbody = table.find('tbody');
            var rows = tbody.find('tr').toArray();

            rows.sort(function(a, b) {
                var aVal = getCellValue(a, column);
                var bVal = getCellValue(b, column);

                if (column === 'floor' || column === 'charges') {
                    aVal = parseFloat(aVal.replace(/[^0-9.-]+/g, "")) || 0;
                    bVal = parseFloat(bVal.replace(/[^0-9.-]+/g, "")) || 0;
                } else {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });

            tbody.empty().append(rows);
        }

        function getCellValue(row, column) {
            var columnIndex = {
                'name': 0,
                'floor': 1,
                'hotel': 2,
                'type': 3,
                'charges': 4
            };

            return $(row).find('td').eq(columnIndex[column]).text().trim();
        }

        function getColumnDisplayName(column) {
            var names = {
                'name': 'Room Name',
                'floor': 'Floor',
                'hotel': 'Hotel',
                'type': 'Room Type',
                'charges': 'Charges'
            };
            return names[column] || column;
        }

        $(document).on('click', '.delete-btn', function () {
            var roomId = $(this).data('room-id');
            var roomName = $(this).data('room-name');

            if (confirm(`Are you sure you want to delete the room: ${roomName}?`)) {
                $.ajax({
                    url: '@Url.Action("Delete", "Rooms")',
                    type: 'POST',
                    data: {
                        id: roomId,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        if (response.success) {
                            toastr.success(response.message, "Deleted");
                            $(`#room-${roomId}`).fadeOut(800, function () {
                                $(this).remove();
                            });
                        } else {
                            toastr.error(response.message, "Error");
                        }
                    },
                    error: function () {
                        toastr.error("An error occurred while deleting the room.", "Error");
                    }
                });
            }
        });

    </script>
}